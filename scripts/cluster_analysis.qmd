---
title: "Food security analysis"
format: html
editor: visual
---

Spatial interpolation

Spatial gridding

# Select the set of variables

```{r}
# save(agric_a, cluster_data, food_employment, s16a_me_agric, conso_agg, survey_welfare, s04_me_employment, survey_ind, cluster_data, wt_cluster_data, file = 'data/cluster_analysis.RData')
load(here('data','short_survey.RData'))
load(here('data','conso_survey.RData'))
load(here('data','full_survey.RData'))
load(here('data','short_survey.RData'))
```

+--------------+-------------------------------------------------------------------------------------+---------------------------+-------------+
| Dimension    | Indicator                                                                           | Variable name             | Data source |
+==============+=====================================================================================+===========================+=============+
| Potential    | Geo-physical characteristics                                                        | zae                       | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Agroecological zones (binomial)                                                     |                           |             |
|              |                                                                                     |                           |             |
|              | Cropland extent                                                                     |                           |             |
+--------------+-------------------------------------------------------------------------------------+---------------------------+-------------+
| Availability | Crop food production                                                                | total_superf_percent_rank | SPAM        |
|              |                                                                                     |                           |             |
|              | Percentile rank of cultivated area by HH                                            | crops_diversity           | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Diversity of cultivated crops by HH (Simpson index)                                 | empl_food_agriculture     | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Distance to market                                                                  | empl_food_processing      | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Distance to the road (RN1, others);                                                 |                           | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Food agriculture employment (%)                                                     |                           |             |
|              |                                                                                     |                           |             |
|              | Food processing employment (%)                                                      |                           |             |
+--------------+-------------------------------------------------------------------------------------+---------------------------+-------------+
| Access       | Local HH crop food production (perc rank)                                           | empl_food_away_home       | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Distance to market                                                                  | fcons_pc                  | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Distance to the road (RN1, others);                                                 | fcons_sh                  | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Milieu (urban/rural)                                                                |                           | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Food-away-from-home employment (%)                                                  |                           | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Food consumption per capita (perc rank)                                             |                           | EHCVM 2018  |
|              |                                                                                     |                           |             |
|              | Share of food in total consumption                                                  |                           |             |
|              |                                                                                     |                           |             |
|              | Share of auto-consumption in total cons.                                            |                           |             |
|              |                                                                                     |                           |             |
|              | Share of women Hh                                                                   |                           |             |
|              |                                                                                     |                           |             |
|              | Conflict intensity index                                                            |                           |             |
+--------------+-------------------------------------------------------------------------------------+---------------------------+-------------+
| Utilization  | Food Consumption Score (FCS)                                                        |                           |             |
|              |                                                                                     |                           |             |
|              | Household Dietary Diversity Scale (HDDS)                                            |                           |             |
|              |                                                                                     |                           |             |
|              | Infant anthropometry (DHS, LSMS)                                                    |                           |             |
|              |                                                                                     |                           |             |
|              | HH characteristics (Hh age, Hh gender, income, etc.)                                |                           |             |
|              |                                                                                     |                           |             |
|              | Distance to / \# of schools (WB)                                                    |                           |             |
|              |                                                                                     |                           |             |
|              | Distance to / \# of pharmacy (WB)                                                   |                           |             |
|              |                                                                                     |                           |             |
|              | Distance principale srce d'approv eau de boisson saison seche s11q28; pluies s11q30 |                           |             |
|              |                                                                                     |                           |             |
|              | Difficultes depenses maladie s20q13\_\_9;                                           |                           |             |
|              |                                                                                     |                           |             |
|              | Difficultes depenses frais de scolarite enfants s20q11                              |                           |             |
+--------------+-------------------------------------------------------------------------------------+---------------------------+-------------+

```{r availability}

### Food agriculture ###

agric_a <- s16a_me_agric %>% 
  select(vague, grappe, menage, s16aq02, s16aq07, s16aq08, s16aq09a, s16aq09b) %>% 
  rename(champ = s16aq02,
         nb_culture = s16aq07,
         princ_culture = s16aq08,
         unit_superf = s16aq09b) %>% 
  mutate(princ_culture = as_factor(princ_culture),
         unit_superf = if_else(s16aq09a > 4000, 2, unit_superf), # treatment of outliers
         superficie_ha = if_else(unit_superf == 2, s16aq09a/10000, s16aq09a) # convert sqrm to ha
         ) %>% 
  filter(!princ_culture == 'NA') %>% 
  left_join(survey_welfare %>% select(hhid, id_adm1, id_adm2, vague, grappe, menage, zae, region, milieu, hhweight, hhsize), by = c("vague", "grappe", "menage")) %>% 
  mutate(zae = as_factor(zae),
         region = str_to_title(as_factor(region)),
         milieu = str_to_title(as_factor(milieu)))

# note: 3615 households, out of the 6024 in the sample, are included. The majority are rural households.

### Cultivated area per HH ###
# note: we build a first dataset at the household level with the variables we plan to aggregate at the ADM-2 level based on the survey design (weighted estimates).

cultivated_area <- agric_a %>%
  select(hhid, superficie_ha) %>% 
  group_by(hhid) %>% 
  summarize(hh_total_superf = sum(superficie_ha)) %>% # total cultivated area per HH
  ungroup() %>% 
  mutate(
    hh_total_superf = if_else(is.na(hh_total_superf), 0, hh_total_superf),
    hh_superf_percent_rank = percent_rank(hh_total_superf)
    ) %>% 
  select(hhid, hh_total_superf, hh_superf_percent_rank)

### Diversity of cultivated crops per HH ###

crop_diversity <- agric_a %>% 
  select(hhid, princ_culture, superficie_ha) %>% 
  pivot_wider(names_from = princ_culture, values_from = superficie_ha, 
              values_fn = sum, names_prefix = "i_", values_fill = 0) %>% 
  group_by(hhid) %>% 
  summarize(crops_diversity = simpson(starts_with('i_'))) %>% # simpson index (one crop = 1, more crops --> 0) 
  ungroup() %>% 
  select(hhid, crops_diversity)


### Food employment ###

# 1. Create a typology of food employment, cf. Allen et al. (2018)
food_employment <- s04_me_employment %>% 
  select(vague, grappe, menage, 
         id_ind = s01q00a, # id ind
         main_empl = s04q28a, # primary job
         month_main_empl = s04q32, # prim. job - total months worked
         day_main_empl = s04q36, # prim. job - days per month worked
         hour_main_empl = s04q37, # prim. job - hours per day worked
         starts_with("s04q29"), # prim. job - job category
         starts_with("s04q30"), # prim. job - activity category
         sec_empl = s04q28b, # secondary job
         month_sec_empl = s04q54, # sec. job - total months worked
         day_sec_empl = s04q55, # sec. job - days per month worked 
         hour_sec_empl = s04q56, # sec. job - hours per day worked 
         starts_with("s04q51"), # prim. job - job category
         starts_with("s04q52") # prim. job - activity category
  ) %>% 
  mutate(
    main_empl = as_factor(main_empl),
    across(starts_with("s04q29"), as_factor),
    across(starts_with("s04q30"), as_factor),
    across(starts_with("s04q51"), as_factor),
    across(starts_with("s04q52"), as_factor)
  ) %>% 
  rename(
    prim_code_emploi = s04q29b,
    prim_code_prof = s04q29d,
    prim_code_section = s04q30b,
    prim_branche_activite = s04q30c,
    prim_code_activite = s04q30d,
    sec_code_emploi = s04q51b,
    sec_code_prof = s04q51d,
    sec_code_section = s04q52b,    
    sec_branche_activite = s04q52c,
    sec_code_activite = s04q52d,
  ) %>% 
  mutate(prim_food_empl = as_factor(case_when(
    # food agriculture
    prim_code_prof %in% c("éleveur de bétail", "Maraîcher", "Cultivateur") ~ "Food agriculture",
    prim_code_section == "Agriculture, pêche, foresterie" ~ "Food agriculture",
    prim_branche_activite %in% c("Agriculture vivrière et activités annexes", "Agriculture industrielle et d'exportation", "Sylviculture, exploitation forestière, activités annexes", "Elevage et chasse") ~ "Food agriculture",

    # food processing
    prim_branche_activite == "Fabrication de produits alimentaires et de boissons" ~ "Food processing",
    # food marketing
    prim_branche_activite == "Commerce de gros et activités d'intermédiaires du commerce de gros" & prim_code_activite == "Commerce de gros de produits agricoles bruts, d'animaux vivants, de produits alimentaires, boissons et tabacs" ~ "Food marketing",
    prim_code_activite %in% c("Commerce de détail de fruits et légumes", "Commerce de détail d’autres produits alimentaires", "Commerce de détail général (alimentation, boutique, épicerie, …)") ~ "Food marketing",
    prim_branche_activite == "Transports terrestres, transport par conduites" ~ "Food marketing",
    prim_code_emploi == "AGRICULTEURS ET OUVRIERS QUALIFIES DE L'AGRICULTURE ET LA PECHE" & prim_code_activite == "Commerce de détail d’autres produits (y compris activités d’intermédiaire du commerce de détail)" ~ "Food marketing",
    # food away-from-home
    prim_branche_activite == "Hôtels et restaurants" ~ "Food away-from-home",
    .default = "Other"
  )),
  sec_food_empl = as_factor(case_when(
    # food agriculture
    sec_code_prof %in% c("ouvrier qualifié de l'agriculture", "autres agriculteurs et ouvriers qualifies de l'agriculture et la peche non classé ailleurs", "Cultivateur", "éleveur de bétail", "Maraîcher", "Ouvrier, manœuvre agricole") ~ "Food agriculture",
    sec_code_section == "Agriculture, pêche, foresterie" ~ "Food agriculture",
    sec_branche_activite %in% c("Agriculture vivrière et activités annexes", "Agriculture industrielle et d'exportation", "Sylviculture, exploitation forestière, activités annexes", "Elevage et chasse") ~ "Food agriculture",
    sec_code_emploi %in% c("éleveur de bétail", "Maraîcher", "Cultivateur") ~ "Food agriculture",
    # food processing
    sec_branche_activite == "Fabrication de produits alimentaires et de boissons" ~ "Food processing",
    # food marketing
    sec_branche_activite == "Commerce de gros et activités d'intermédiaires du commerce de gros" & sec_code_activite == "Commerce de gros de produits agricoles bruts, d'animaux vivants, de produits alimentaires, boissons et tabacs" ~ "Food marketing",
    sec_code_activite %in% c("Commerce de détail de fruits et légumes", "Commerce de détail d’autres produits alimentaires", "Commerce de détail général (alimentation, boutique, épicerie, …)") ~ "Food marketing",
    sec_branche_activite == "Transports terrestres, transport par conduites" ~ "Food marketing",
    sec_code_emploi %in% c("AGRICULTEURS ET OUVRIERS QUALIFIES DE L'AGRICULTURE ET LA PECHE", "Ouvrier, manœuvre agricole") & sec_code_activite == "Commerce de détail d’autres produits (y compris activités d’intermédiaire du commerce de détail)" ~ "Food marketing",
    sec_code_prof %in% c("vendeur de fruits", "vendeur de céréales", "vendeur de vivres frais (alloco, igname, taro, autres féculents)", "vendeur de légumes et arachides et tous condiments", "Boucher - vendeur", "Docker") ~ "Food marketing",
    # food away-from-home
    sec_branche_activite == "Hôtels et restaurants" ~ "Food away-from-home",
    sec_code_prof %in% c("vendeur de beignets et d'autres aliments préparés (vendeur d'aliments)") ~ "Food away-from-home",
    .default = "Other"
  ))
  ) %>% 
    relocate(c("prim_food_empl", "sec_food_empl"))

# 2. Convert time worked in Full-time equivalent (FTE)
food_fte <- food_employment %>% 
  right_join(survey_ind %>% select(vague, grappe, menage, id_ind = numind, hhid, sexe, age), by =c("vague", "grappe", "menage", "id_ind")) %>% 
  mutate( # create full-time equivalent variable
    fte_prim = (hour_main_empl*day_main_empl*month_main_empl)/(40*52),
    fte_sec = (hour_sec_empl*day_sec_empl*month_sec_empl)/(40*52),
    fte_agriculture = case_when(
                prim_food_empl == "Food agriculture" ~ fte_prim,
                sec_food_empl == "Food agriculture" ~ fte_sec,
                .default = 0),
    fte_processing = case_when(
                prim_food_empl == "Food processing" ~ fte_prim,
                sec_food_empl == "Food processing" ~ fte_sec,
                .default = 0),
    fte_marketing = case_when(
                prim_food_empl == "Food marketing" ~ fte_prim,
                sec_food_empl == "Food marketing" ~ fte_sec,
                .default = 0),          
    fte_away_home = case_when(
                prim_food_empl == "Food away-from-home" ~ fte_prim,
                sec_food_empl == "Food away-from-home" ~ fte_sec,
                .default = 0)
  ) %>% 
  group_by(hhid) %>% 
  summarize(
    fte_agriculture = sum(fte_agriculture, na.rm = TRUE),
    fte_processing = sum(fte_processing, na.rm = TRUE),
    fte_marketing = sum(fte_marketing, na.rm = TRUE),
    fte_away_home = sum(fte_away_home, na.rm = TRUE)
    ) %>% 
  rowwise() %>% 
  mutate(fte_total = sum(c(fte_agriculture, fte_processing, fte_marketing, fte_away_home))) %>% 
  ungroup()


### Food Consumption ### 

food_consumption <- survey_welfare %>% 
  mutate(
    fcons_pc = dali/(eqadu1*def_spa*def_temp), # food consumption per capita
    fcons_pc_percentile_rank = percent_rank(fcons_pc), # percentile rank
    sh_fcons = (dali/dtot)*100 # share of food consumption in total consumption
  ) %>% 
  select(hhid, fcons_pc, fcons_pc_percentile_rank, sh_fcons)

### Food Consumption score ###        
              
### HH characteristics ###  

hh_characteristics <- survey_welfare %>% 
  rename(
    h_literacy = halfab,
    h_gender = hgender,
    h_handicap = hhandig,
    h_unemploy = hactiv12m 
  ) %>% 
  mutate(across(starts_with("h_"), as.factor),
         h_gender = if_else(h_gender==2, 1, 0),
         h_unemploy = if_else(h_unemploy==1 | h_unemploy==2, 1, 0)
         ) %>% # male=0, female=1
  select(hhid, h_literacy, h_gender, h_handicap, h_unemploy)

# Combine all dataframes in a new dataset
cluster_data <- survey_welfare %>% 
  select(hhid, grappe, region, zae, hhweight, id_adm1, id_adm2) %>% 
  left_join(cultivated_area, by = "hhid") %>% 
  left_join(crop_diversity, by = "hhid") %>% 
  left_join(food_fte, by = "hhid") %>% 
  left_join(food_consumption, by = "hhid") %>% 
  left_join(hh_characteristics, by = "hhid")

# Survey design
survey_design <- cluster_data %>% 
  as_survey_design(ids = c(grappe,hhid), 
                   strata = c(region, zae), 
                   weights = hhweight,
                   nest = TRUE)

# Create weighted variables 

wt_sh_fcons <- survey_design %>% 
  group_by(id_adm2) %>% 
  summarise(sh_food_cons = survey_mean(sh_fcons, na.rm = TRUE),
            food_cons_pc = survey_mean(fcons_pc_percentile_rank, na.rm = TRUE))

wt_crop_production <- survey_design %>% 
  group_by(id_adm2) %>%
  summarise(crops_diversity = survey_mean(crops_diversity, na.rm = TRUE),
            cultivated_area = survey_mean(hh_superf_percent_rank, na.rm = TRUE))
    
wt_empl_food <- survey_design %>% 
  group_by(id_adm2) %>% 
  summarise(empl_food_agriculture = survey_ratio(fte_agriculture, fte_total),
            empl_food_processing = survey_ratio(fte_processing, fte_total),
            empl_food_marketing = survey_ratio(fte_marketing, fte_total),
            empl_food_away_home = survey_ratio(fte_away_home, fte_total),
            )

wt_h_gender <- survey_design %>% 
  group_by(id_adm2, h_gender) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_gender, pct) %>% 
  pivot_wider(names_from = h_gender, values_from = pct) %>% 
  rename(hh_male = '0',
         hh_female = '1') %>% 
  ungroup()

wt_h_literacy <- survey_design %>% 
  group_by(id_adm2, h_literacy) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_literacy, pct) %>% 
  pivot_wider(names_from = h_literacy, values_from = pct) %>% 
  rename(hh_literacy = '1') %>% 
  select(id_adm2, hh_literacy) %>% 
  ungroup()

wt_h_handicap <- survey_design %>% 
  group_by(id_adm2, h_handicap) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_handicap, pct) %>% 
  pivot_wider(names_from = h_handicap, values_from = pct) %>% 
  rename(hh_handicap = '1') %>% 
  select(id_adm2, hh_handicap) %>% 
  ungroup()

wt_h_unemploy <- survey_design %>% 
  group_by(id_adm2, h_unemploy) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_unemploy, pct) %>% 
  pivot_wider(names_from = h_unemploy, values_from = pct) %>% 
  rename(hh_unemploy = '0') %>% 
  select(id_adm2, hh_unemploy) %>% 
  ungroup()


wt_cluster_data <- wt_sh_fcons %>% 
  left_join(wt_crop_production, by = "id_adm2") %>% 
  left_join(wt_empl_food, by = "id_adm2") %>% 
  left_join(wt_h_gender, by = "id_adm2") %>% 
  left_join(wt_h_literacy, by = "id_adm2") %>%  
  left_join(wt_h_handicap, by = "id_adm2") %>% 
  left_join(wt_h_unemploy, by = "id_adm2") %>% 
  select(-ends_with("_se"))

# vis_dat(wt_cluster_data)
wt_cluster_data <- wt_cluster_data %>% 
  mutate(across(hh_male:hh_unemploy, \(x) replace_na(x, 0)))

# Add labels to new variables
var_label(survey_design) <- list(
  cultivated_area = "Percent rank at the country-level of the total area cultivated by households",
  crops_diversity = "Simpson index of the crops cultivated by households"
)

var_label(survey_design$total_superf_percent_rank)
```

# Vulnerability profiles

Objective: account for local creation and reinforcement of vulnerability

## Correlation matrix

```{r}

cluster_df <- column_to_rownames(wt_cluster_data |> 
                                   select(-hh_male), var = "id_adm2")

cluster_norm <- cluster_df |> mutate(across(where(is.numeric), scale))

GGally::ggpairs(cluster_df)
ppsr::visualize_pps(cluster_df)

corr_matrix <- cor(cluster_norm)
score_matrix <- score_matrix(cluster_df)
cov_matrix <- cov(cluster_df)

ggcorrplot(corr_matrix)

tmwr_cols <- colorRampPalette(c("#91CBD765", "#CA225E"))
corr_matrix %>% 
  corrplot(col = tmwr_cols(200), tl.col = "black", method = "ellipse")

```

## PCA

```{r}
data_pca <- princomp(cluster_norm)
summary(data_pca)
data_scores <- data_pca$scores[, 1:4]
# Kaizer criterion: keep eigenvalue PC > 1
data_pca$sdev ^ 2
# loadings of each principal component
data_pca$loadings[, 1:4]

res.pca <- PCA(cluster_norm, graph = FALSE)
summary(res.pca)
res.scores <- res.pca$ind$coord[, 1:4]
# Kaizer criterion: keep eigenvalue PC > 1
res.pca$eig[,1]^2

# scree plot
fviz_eig(data_pca, addlabels = TRUE)

# biplot of the attributes
fviz_pca_var(data_pca, col.var = "black")
# contribution of each variable (cos2 = quality of representation)
fviz_cos2(data_pca, choice = "var", axes = 1:2)
# biplot combined with cos2
fviz_pca_var(data_pca, col.var = "cos2",
             gradient.cols = c("grey", "orange", "red"),
             repel = TRUE)


```

## Hierarchical clustering

Ward's method

```{r distance}

data_dist <- dist(data_scores, method = "euclidian") # distance matrix
data_daisy <- daisy(data_scores)

res.dist <- dist(res.scores, method = "euclidian")
res.daisy <- daisy(res.scores)

```

```{r hcluster}

data_tree <- hclust(data_dist, method = "ward.D2")
res.tree <- hclust(res.dist, method = "ward.D2")

# measure how well the cluster tree reflects the data: compute correlation between the cophenetic distances and the distance matrix (i.e. here factor scores); high correlation means high accuracy of the clustering solution.
tree_coph <- cophenetic(tree)
cor(data_dist, tree_coph)
# test different distance methods

# cut and visualize tree into clusters
fviz_dend(tree, k = 4, # cut in four groups
     cex = .5, # label size
     horiz = TRUE,
     k_colors = "jco", # other option: c("#2E9FDF", "#00AFBB", "E7B800", "#FC4E07")
     rect = TRUE,
     rect_border = "jco",
     rect_fill = TRUE
)

# graph visualization
require("igraph")
fviz_dend(tree, k = 4, k_colors = "jco", type = "phylogenic", repel = TRUE)

# heatmap
pheatmap::pheatmap(data_dist, cutree_rows = 4)


cluster <- cutree(data_tree, k = 4)
cluster_tree <- data.frame(cluster, cluster_df)

# rownames(cluster_norm)[cluster == 1]

# estimate mean of all variables
mean_total <- bind_rows(map(cluster_df, mean))

# estimate mean for each cluster
mean_cluster <- cluster_tree |> 
  group_by(cluster) |> 
  summarize(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))

# estimate difference between total and cluster means
mean_all <- bind_rows(mean_total, mean_cluster)

1:4 %>%
  walk(function(profiling) {
    mean_cluster - mean_all
  })


# deviation from average for all variables for each cluster
# estimate mean of all variables; estimate mean for each cluster; estimate difference between total and cluster means; plot


```

Density is used as an illustrative variable \[include it in the mapping?\]

# GIS / spatial analysis

Objective: map the spatial distribution of each vulnerability profile and compare them to various hazards.

## Spatial clustering (spatial autocorrelation)

Global Moran's I and Geary's C statistics on each vulnerability profile

Spatial distribution / spatial overlay of each vulnerability profile with different hazards' delineations

# Sensitivity and uncertainty analysis

Hex grid / ADM

K-Means algorithm, Fuzzy geographically weighted clustering adds neighborhood and population effect
