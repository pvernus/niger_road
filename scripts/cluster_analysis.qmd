---
title: "Food security analysis"
format: html
editor: visual
---

# Select the set of variables

```{r}
# save(hh_food_prod, cluster_data, food_employment, s16a_me_agric, conso_agg, survey_welfare, s04_me_employment, survey_ind, cluster_data, wt_cluster_data, mean_cluster_list, file = 'data/cluster_analysis.RData')
load(here('data','short_survey.RData'))
load(here('data','conso_survey.RData'))
load(here('data','full_survey.RData'))
```

+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
| Dimension    | Type           | Indicator                                                                             | Variable name             | Data source |
+==============+================+=======================================================================================+===========================+=============+
| Potential    | Geo-physical   | X Agroecological zones (binomial)                                                     | zae                       | EHCVM 2018  |
|              |                |                                                                                       |                           |             |
|              |                | Cropland extent                                                                       |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | Altitude                                                                              |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | X Milieu (urban/rural)                                                                |                           |             |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
| Availability | Geo-physical   | Crop food production                                                                  |                           | SPAM        |
|              |                |                                                                                       |                           |             |
|              |                |                                                                                       |                           | EHCVM 2018  |
|              |                |                                                                                       |                           |             |
|              |                |                                                                                       |                           | EHCVM 2018  |
|              |                |                                                                                       |                           |             |
|              |                |                                                                                       |                           | EHCVM 2018  |
|              |                |                                                                                       |                           |             |
|              |                |                                                                                       |                           | EHCVM 2018  |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
|              | Infrastructure |                                                                                       |                           |             |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
|              | Socio-economic | Crop food production (total and main crops)                                           | crop_production_total     | SPAM        |
|              |                |                                                                                       |                           |             |
|              |                | Crop food production diversity                                                        | crop_food_production\_\*  | EHCVM 2018  |
|              |                |                                                                                       |                           |             |
|              |                | Cultivated area by HH                                                                 | crop_production_diversity |             |
|              |                |                                                                                       |                           |             |
|              |                | Diversity of cultivated crops by HH (Simpson index)                                   | cultivated_area           |             |
|              |                |                                                                                       |                           |             |
|              |                | Food agriculture employment (%)                                                       | empl_food_agriculture     |             |
|              |                |                                                                                       |                           |             |
|              |                | Food processing employment (%)                                                        | empl_food_processing      |             |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
| Access       | Infrastructure | X Distance to market                                                                  |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | X Distance to the road (RN1, others)                                                  |                           |             |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
|              | Socio-economic | Food-away-from-home employment (%)                                                    | empl_food_away_home       | EHCVM 2018  |
|              |                |                                                                                       |                           |             |
|              |                | Food consumption per capita                                                           | fcons_pc                  |             |
|              |                |                                                                                       |                           |             |
|              |                | Share of food in total consumption                                                    | fcons_sh                  |             |
|              |                |                                                                                       |                           |             |
|              |                | X Share of auto-consumption in total cons.                                            | hh_gender                 |             |
|              |                |                                                                                       |                           |             |
|              |                | Share of women Hh                                                                     | hh_unemploy               |             |
|              |                |                                                                                       |                           |             |
|              |                | X Conflict intensity index                                                            |                           |             |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
| Utilization  | Infrastructure | X Distance to / \# of schools (WB)                                                    |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | X Distance to / \# of pharmacy (WB)                                                   |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | X Distance principale srce d'approv eau de boisson saison seche s11q28; pluies s11q30 |                           |             |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+
|              | Socio-economic | X Food Consumption Score (FCS)                                                        | hh_gender                 |             |
|              |                |                                                                                       |                           |             |
|              |                | X Household Dietary Diversity Scale (HDDS)                                            | hh_literacy               |             |
|              |                |                                                                                       |                           |             |
|              |                | X Infant anthropometry (DHS, LSMS)                                                    |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | HH characteristics (Hh age, Hh gender, income, etc.)                                  |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | X Difficultes depenses maladie s20q13\_\_9;                                           |                           |             |
|              |                |                                                                                       |                           |             |
|              |                | X Difficultes depenses frais de scolarite enfants s20q11                              |                           |             |
+--------------+----------------+---------------------------------------------------------------------------------------+---------------------------+-------------+

```{r agriculture}

dist_agric <- s03_co_agric |> 
  select(grappe, vague, dist_eqp_ag = s03q07, dist_seed = s03q09,
         dist_org_fertilizer = s03q11, dist_chem_fertilizer = s03q13, 
         dist_pest = s03q15)
dist_agric |> vis_miss() # too many missing observations
```

```{r hh_food_prod}

### Households' food production ###

hh_food_prod <- s16a_me_agric %>% 
  select(vague, grappe, menage, s16aq02, s16aq07, s16aq08, s16aq09a, s16aq09b) %>% 
  rename(champ = s16aq02,
         nb_culture = s16aq07,
         princ_culture = s16aq08,
         unit_superf = s16aq09b) %>% 
  mutate(princ_culture = as_factor(princ_culture),
         unit_superf = if_else(s16aq09a > 4000, 2, unit_superf), # treatment of outliers
         superficie_ha = if_else(unit_superf == 2, s16aq09a/10000, s16aq09a) # convert sqrm to ha
         ) %>% 
  mutate(superficie_ha = if_else(is.na(superficie_ha), 0, superficie_ha)) |> 
  filter(!princ_culture == 'NA') %>% 
  left_join(survey_welfare %>% select(hhid, id_adm1, id_adm2, vague, grappe, menage, zae, region, milieu, hhweight, hhsize), by = c("vague", "grappe", "menage")) %>% 
  mutate(zae = as_factor(zae),
         region = str_to_title(as_factor(region)),
         milieu = str_to_title(as_factor(milieu)))

# note: 3615 households, out of the 6024 in the sample, are included. The majority are rural households.

## Cultivated area per HH ##

cultivated_area <- hh_food_prod %>%
  select(hhid, superficie_ha) %>% 
  group_by(hhid) %>% 
  summarize(hh_total_superf = sum(superficie_ha)) %>% # total cultivated area per HH
  ungroup() %>% 
  mutate(hh_total_superf = if_else(is.na(hh_total_superf), 0, hh_total_superf)) %>%
  select(hhid, hh_total_superf)

## Diversity of cultivated crops per HH ##

crop_diversity <- hh_food_prod %>% 
  select(hhid, princ_culture, superficie_ha) %>% 
  pivot_wider(names_from = princ_culture, values_from = superficie_ha, 
              values_fn = sum, names_prefix = "i_", values_fill = 0) %>% 
  group_by(hhid) %>% 
  summarize(crop_diversity = simpson(starts_with('i_'))) %>% # simpson index (one crop = 1, more crops --> 0) 
  ungroup() %>% 
  select(hhid, crop_diversity)

```

```{r food_employment}

### Food employment ###

# 1. Create a typology of food employment, cf. Allen et al. (2018)
food_employment <- s04_me_employment %>% 
  select(vague, grappe, menage, 
         id_ind = s01q00a, # id ind
         main_empl = s04q28a, # primary job
         month_main_empl = s04q32, # prim. job - total months worked
         day_main_empl = s04q36, # prim. job - days per month worked
         hour_main_empl = s04q37, # prim. job - hours per day worked
         starts_with("s04q29"), # prim. job - job category
         starts_with("s04q30"), # prim. job - activity category
         sec_empl = s04q28b, # secondary job
         month_sec_empl = s04q54, # sec. job - total months worked
         day_sec_empl = s04q55, # sec. job - days per month worked 
         hour_sec_empl = s04q56, # sec. job - hours per day worked 
         starts_with("s04q51"), # prim. job - job category
         starts_with("s04q52") # prim. job - activity category
  ) %>% 
  mutate(
    main_empl = as_factor(main_empl),
    across(starts_with("s04q29"), as_factor),
    across(starts_with("s04q30"), as_factor),
    across(starts_with("s04q51"), as_factor),
    across(starts_with("s04q52"), as_factor)
  ) %>% 
  rename(
    prim_code_emploi = s04q29b,
    prim_code_prof = s04q29d,
    prim_code_section = s04q30b,
    prim_branche_activite = s04q30c,
    prim_code_activite = s04q30d,
    sec_code_emploi = s04q51b,
    sec_code_prof = s04q51d,
    sec_code_section = s04q52b,    
    sec_branche_activite = s04q52c,
    sec_code_activite = s04q52d,
  ) %>% 
  mutate(prim_food_empl = as_factor(case_when(
    # food agriculture
    prim_code_prof %in% c("éleveur de bétail", "Maraîcher", "Cultivateur") ~ "Food agriculture",
    prim_code_section == "Agriculture, pêche, foresterie" ~ "Food agriculture",
    prim_branche_activite %in% c("Agriculture vivrière et activités annexes", "Agriculture industrielle et d'exportation", "Sylviculture, exploitation forestière, activités annexes", "Elevage et chasse") ~ "Food agriculture",

    # food processing
    prim_branche_activite == "Fabrication de produits alimentaires et de boissons" ~ "Food processing",
    # food marketing
    prim_branche_activite == "Commerce de gros et activités d'intermédiaires du commerce de gros" & prim_code_activite == "Commerce de gros de produits agricoles bruts, d'animaux vivants, de produits alimentaires, boissons et tabacs" ~ "Food marketing",
    prim_code_activite %in% c("Commerce de détail de fruits et légumes", "Commerce de détail d’autres produits alimentaires", "Commerce de détail général (alimentation, boutique, épicerie, …)") ~ "Food marketing",
    prim_branche_activite == "Transports terrestres, transport par conduites" ~ "Food marketing",
    prim_code_emploi == "AGRICULTEURS ET OUVRIERS QUALIFIES DE L'AGRICULTURE ET LA PECHE" & prim_code_activite == "Commerce de détail d’autres produits (y compris activités d’intermédiaire du commerce de détail)" ~ "Food marketing",
    # food away-from-home
    prim_branche_activite == "Hôtels et restaurants" ~ "Food away-from-home",
    .default = "Other"
  )),
  sec_food_empl = as_factor(case_when(
    # food agriculture
    sec_code_prof %in% c("ouvrier qualifié de l'agriculture", "autres agriculteurs et ouvriers qualifies de l'agriculture et la peche non classé ailleurs", "Cultivateur", "éleveur de bétail", "Maraîcher", "Ouvrier, manœuvre agricole") ~ "Food agriculture",
    sec_code_section == "Agriculture, pêche, foresterie" ~ "Food agriculture",
    sec_branche_activite %in% c("Agriculture vivrière et activités annexes", "Agriculture industrielle et d'exportation", "Sylviculture, exploitation forestière, activités annexes", "Elevage et chasse") ~ "Food agriculture",
    sec_code_emploi %in% c("éleveur de bétail", "Maraîcher", "Cultivateur") ~ "Food agriculture",
    # food processing
    sec_branche_activite == "Fabrication de produits alimentaires et de boissons" ~ "Food processing",
    # food marketing
    sec_branche_activite == "Commerce de gros et activités d'intermédiaires du commerce de gros" & sec_code_activite == "Commerce de gros de produits agricoles bruts, d'animaux vivants, de produits alimentaires, boissons et tabacs" ~ "Food marketing",
    sec_code_activite %in% c("Commerce de détail de fruits et légumes", "Commerce de détail d’autres produits alimentaires", "Commerce de détail général (alimentation, boutique, épicerie, …)") ~ "Food marketing",
    sec_branche_activite == "Transports terrestres, transport par conduites" ~ "Food marketing",
    sec_code_emploi %in% c("AGRICULTEURS ET OUVRIERS QUALIFIES DE L'AGRICULTURE ET LA PECHE", "Ouvrier, manœuvre agricole") & sec_code_activite == "Commerce de détail d’autres produits (y compris activités d’intermédiaire du commerce de détail)" ~ "Food marketing",
    sec_code_prof %in% c("vendeur de fruits", "vendeur de céréales", "vendeur de vivres frais (alloco, igname, taro, autres féculents)", "vendeur de légumes et arachides et tous condiments", "Boucher - vendeur", "Docker") ~ "Food marketing",
    # food away-from-home
    sec_branche_activite == "Hôtels et restaurants" ~ "Food away-from-home",
    sec_code_prof %in% c("vendeur de beignets et d'autres aliments préparés (vendeur d'aliments)") ~ "Food away-from-home",
    .default = "Other"
  ))
  ) %>% 
    relocate(c("prim_food_empl", "sec_food_empl"))

# 2. Convert time worked in Full-time equivalent (FTE)
food_fte <- food_employment %>% 
  right_join(survey_ind %>% select(vague, grappe, menage, id_ind = numind, hhid, sexe, age), by =c("vague", "grappe", "menage", "id_ind")) %>% 
  mutate( # create full-time equivalent variable
    fte_prim = (hour_main_empl*day_main_empl*month_main_empl)/(40*52),
    fte_sec = (hour_sec_empl*day_sec_empl*month_sec_empl)/(40*52),
    fte_agriculture = case_when(
                prim_food_empl == "Food agriculture" ~ fte_prim,
                sec_food_empl == "Food agriculture" ~ fte_sec,
                .default = 0),
    fte_processing = case_when(
                prim_food_empl == "Food processing" ~ fte_prim,
                sec_food_empl == "Food processing" ~ fte_sec,
                .default = 0),
    fte_marketing = case_when(
                prim_food_empl == "Food marketing" ~ fte_prim,
                sec_food_empl == "Food marketing" ~ fte_sec,
                .default = 0),          
    fte_away_home = case_when(
                prim_food_empl == "Food away-from-home" ~ fte_prim,
                sec_food_empl == "Food away-from-home" ~ fte_sec,
                .default = 0)
  ) %>% 
  group_by(hhid) %>% 
  summarize(
    fte_agriculture = sum(fte_agriculture, na.rm = TRUE),
    fte_processing = sum(fte_processing, na.rm = TRUE),
    fte_marketing = sum(fte_marketing, na.rm = TRUE),
    fte_away_home = sum(fte_away_home, na.rm = TRUE)
    ) %>% 
  rowwise() %>% 
  mutate(fte_total = sum(c(fte_agriculture, fte_processing, fte_marketing, fte_away_home))) %>% 
  ungroup()

```

```{r food_consumption}

### Food Consumption ### 

food_consumption <- survey_welfare %>% 
  mutate(
    fcons_pc = dali/(eqadu1*def_spa*def_temp), # food consumption per capita
    fcons_pc_percentile_rank = percent_rank(fcons_pc), # percentile rank
    sh_fcons = (dali/dtot)*100 # share of food consumption in total consumption
  ) %>% 
  select(hhid, fcons_pc, fcons_pc_percentile_rank, sh_fcons)

### Food Consumption score ### 
```

```{r hh_char}

### HH characteristics ###  

hh_characteristics <- survey_welfare %>% 
  rename(
    h_literacy = halfab,
    h_gender = hgender,
    h_handicap = hhandig,
    h_unemploy = hactiv12m 
  ) %>% 
  mutate(across(starts_with("h_"), as.factor),
         h_gender = if_else(h_gender==2, 0, 1),
         h_unemploy = if_else(h_unemploy==1 | h_unemploy==2, 1, 0)
         ) %>% # male=0, female=1
  select(hhid, h_literacy, h_gender, h_handicap, h_unemploy)
```

```{r merged_data}

# Combine all dataframes in a new dataset
merged_data <- survey_welfare %>% 
  select(hhid, grappe, region, zae, hhweight, id_adm1, id_adm2) %>% 
  left_join(cultivated_area, by = "hhid") %>% 
  left_join(crop_diversity, by = "hhid") %>% 
  mutate(crop_diversity = if_else(is.na(crop_diversity), 0, crop_diversity),
         hh_total_superf = if_else(is.na(hh_total_superf), 0, hh_total_superf)) |> 
  left_join(food_fte, by = "hhid") %>% 
  left_join(food_consumption, by = "hhid") %>% 
  left_join(hh_characteristics, by = "hhid")

```

```{r weighted_data}

# Survey design
survey_design <- cluster_data %>% 
  as_survey_design(ids = c(grappe,hhid), 
                   strata = c(region, zae), 
                   weights = hhweight,
                   nest = TRUE)

# Create weighted variables 

wt_sh_fcons <- survey_design %>% 
  group_by(id_adm2) %>% 
  summarise(sh_food_cons = survey_mean(sh_fcons, na.rm = TRUE),
            food_cons_pc = survey_mean(fcons_pc_percentile_rank, na.rm = TRUE))

wt_crop_production <- survey_design %>% 
  group_by(id_adm2) %>%
  summarise(crops_diversity = survey_mean(crops_diversity, na.rm = TRUE),
            cultivated_area = survey_mean(hh_superf_percent_rank, na.rm = TRUE))
    
wt_empl_food <- survey_design %>% 
  group_by(id_adm2) %>% 
  summarise(empl_food_agriculture = survey_ratio(fte_agriculture, fte_total),
            empl_food_processing = survey_ratio(fte_processing, fte_total),
            empl_food_marketing = survey_ratio(fte_marketing, fte_total),
            empl_food_away_home = survey_ratio(fte_away_home, fte_total),
            )

wt_h_gender <- survey_design %>% 
  group_by(id_adm2, h_gender) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_gender, pct) %>% 
  pivot_wider(names_from = h_gender, values_from = pct) %>% 
  rename(hh_male = '0',
         hh_female = '1') %>% 
  ungroup()

wt_h_literacy <- survey_design %>% 
  group_by(id_adm2, h_literacy) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_literacy, pct) %>% 
  pivot_wider(names_from = h_literacy, values_from = pct) %>% 
  rename(hh_literacy = '1') %>% 
  select(id_adm2, hh_literacy) %>% 
  ungroup()

wt_h_handicap <- survey_design %>% 
  group_by(id_adm2, h_handicap) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_handicap, pct) %>% 
  pivot_wider(names_from = h_handicap, values_from = pct) %>% 
  rename(hh_handicap = '1') %>% 
  select(id_adm2, hh_handicap) %>% 
  ungroup()

wt_h_unemploy <- survey_design %>% 
  group_by(id_adm2, h_unemploy) %>% 
  summarise(pct = survey_prop()) %>% 
  select(id_adm2, h_unemploy, pct) %>% 
  pivot_wider(names_from = h_unemploy, values_from = pct) %>% 
  rename(hh_unemploy = '0') %>% 
  select(id_adm2, hh_unemploy) %>% 
  ungroup()

# Merge all weighted data in a single data set
wt_cluster_data <- wt_sh_fcons %>% 
  left_join(wt_crop_production, by = "id_adm2") %>% 
  left_join(wt_empl_food, by = "id_adm2") %>% 
  left_join(wt_h_gender, by = "id_adm2") %>% 
  left_join(wt_h_literacy, by = "id_adm2") %>%  
  left_join(wt_h_handicap, by = "id_adm2") %>% 
  left_join(wt_h_unemploy, by = "id_adm2") %>% 
  select(-ends_with("_se"))

# vis_dat(wt_cluster_data)
wt_cluster_data <- wt_cluster_data %>% 
  mutate(across(hh_male:hh_unemploy, \(x) replace_na(x, 0)))

# Add labels to new variables
var_label(wt_cluster_data) <- list(
  id_adm2 = "ID ADM-2",
  sh_food_cons = "Average share of food consumption in households' total expenditures",
  food_cons_pc = "Average percentile rank at the country-level of households' food consumption per capita",
  crops_diversity = "Food crops diversity cultivated by households (Simpson Index)",
  cultivated_area = "Average percentile rank at the country-level of households' cultivated area",
  empl_food_agriculture = "Avarage share of food agriculture jobs in food employment at the ADM-2 level",
  empl_food_processing = "Avarage share of food processing jobs in food employment at the ADM-2 level",
  empl_food_marketing = "Avarage share of food marketing jobs in food employment at the ADM-2 level",
  empl_food_away_home = "Avarage share of food away-from-home jobs in food employment at the ADM-2 level",
  hh_female = "Average share of female-led households at the ADM-2 level",
  hh_literacy = "Average share of household heads who knows how to read",
  hh_handicap = "Average share of household heads with an handicap",
  hh_unemploy = "Average share of household heads who are unemployed"
)

```

```{r cluster_data}

cluster_survey_data <- merged_data |> 
  mutate(across(c(h_literacy, h_handicap), \(x) as.numeric(levels(x)[x]))) |> 
  group_by(grappe) |> 
  summarize(
    sh_food_cons = mean(sh_fcons, na.rm = TRUE), # food consumption
    food_cons_pc = mean(fcons_pc, na.rm = TRUE),
    crop_diversity = mean(crop_diversity, na.rm = TRUE), # auto-production
    cultivated_area = mean(hh_total_superf, na.rm = TRUE),
    empl_food_agriculture = sum(fte_agriculture)/sum(fte_total), # food empl
    empl_food_processing = sum(fte_processing)/sum(fte_total),
    empl_food_marketing = sum(fte_marketing)/sum(fte_total),
    empl_food_away_home = sum(fte_away_home)/sum(fte_total),
    hh_literacy = sum(h_literacy) / length(h_literacy), # head of HH charastest.
    hh_handicap = sum(h_handicap) / length(h_handicap),
    hh_gender = sum(h_gender) / length(h_gender),
    hh_unemploy = sum(h_unemploy) / length(h_unemploy)
  )

cluster_data <- cluster_survey_data |> 
  left_join(crop_production, by = "grappe") |> 
  left_join(cropland |> select(grappe, cropland, cropland_change_1519), by = "grappe") |> 
  mutate_all(\(x) if_else(is.na(x), 0, x))
  
```

```{r labels}
# Add labels to new variables
var_label(cluster_data) <- list(
  grappe = "Grappe/Communauté",
  sh_food_cons = "Average share of food consumption in households' total expenditures",
  food_cons_pc = "Average percentile rank at the country-level of households' food consumption per capita",
  crop_diversity = "Food crops diversity cultivated by households (Simpson Index)",
  cultivated_area = "Average percentile rank at the country-level of households' cultivated area",
  empl_food_agriculture = "Avarage share of food agriculture jobs in food employment at the ADM-2 level",
  empl_food_processing = "Avarage share of food processing jobs in food employment at the ADM-2 level",
  empl_food_marketing = "Avarage share of food marketing jobs in food employment at the ADM-2 level",
  empl_food_away_home = "Avarage share of food away-from-home jobs in food employment at the ADM-2 level",
  hh_gender = "Average share of male-led households",
  hh_literacy = "Average share of household heads who knows how to read",
  hh_handicap = "Average share of household heads with an handicap",
  hh_unemploy = "Average share of household heads who are unemployed"
)
```

# Vulnerability profiles

Objective: account for local creation and reinforcement of vulnerability

## Correlation matrix

```{r corr_matrix}

cluster_df <- column_to_rownames(cluster_data, var = "grappe")
cluster_norm <- scale(cluster_df) |> 
  as.data.frame()

GGally::ggpairs(cluster_df)
ppsr::visualize_pps(cluster_df)

corr_matrix <- cor(scale(cluster_df))
score_matrix <- score_matrix(cluster_df)
cov_matrix <- cov(cluster_df)

ggcorrplot(corr_matrix)

tmwr_cols <- colorRampPalette(c("#91CBD765", "#CA225E"))
corr_matrix %>% 
  corrplot(col = tmwr_cols(200), tl.col = "black", method = "ellipse")

PerformanceAnalytics::chart.Correlation(cluster_df, method = "pearson")
PerformanceAnalytics::chart.Correlation(cluster_norm, method = "pearson")

# heatmap
heatmap(corr_matrix, scale = "none")

col <- colorRampPalette(brewer.pal(10, "RdYlBu"))(256)
heatmap(corr_matrix, scale = "none", col =  rev(col))

pheatmap(corr_matrix, cutree_rows = 4)

# gplots::heatmap.2(corr_matrix, scale = "none", col = bluered(100),t race = "none", density.info = "none")

```

## PCA

```{r pca}

data_pca <- princomp(cluster_norm)
summary(data_pca)
data_scores <- data_pca$scores[, 1:5]
# Kaizer criterion: keep eigenvalue PC > 1
data_pca$sdev ^ 2
# loadings of each principal component
data_pca$loadings[, 1:5]

res.pca <- PCA(cluster_norm, graph = FALSE)
summary(res.pca)
res.scores <- res.pca$ind$coord[, 1:5]
# Kaizer criterion: keep eigenvalue PC > 1
res.pca$eig[,1]^2

# scree plot
fviz_eig(data_pca, addlabels = TRUE)

# biplot of the attributes
fviz_pca_var(data_pca, col.var = "black")
# contribution of each variable (cos2 = quality of representation)
fviz_cos2(data_pca, choice = "var", axes = 1:2)
# biplot combined with cos2
fviz_pca_var(data_pca, col.var = "cos2",
             gradient.cols = c("grey", "orange", "red"),
             repel = TRUE)

```

## Hierarchical clustering

Ward's method

```{r distance}

data_dist <- dist(data_scores, method = "euclidian") # distance matrix
data_daisy <- daisy(data_scores)

res.dist <- dist(res.scores, method = "euclidian")
res.daisy <- daisy(res.scores)

```

```{r hcluster}

data_tree <- hclust(data_dist, method = "ward.D2")
res.tree <- hclust(res.dist, method = "ward.D2")

# measure how well the cluster tree reflects the data: compute correlation between the cophenetic distances and the distance matrix (i.e. here factor scores); high correlation means high accuracy of the clustering solution.
tree_coph <- cophenetic(data_tree)
cor(data_dist, tree_coph)
# test different distance methods

# cut and visualize tree into clusters


# graph visualization
require("igraph")
fviz_dend(data_tree, k = 3, # cut in four groups
     cex = .5, # label size
     horiz = TRUE,
     k_colors = "jco", # other option: c("#2E9FDF", "#00AFBB", "E7B800", "#FC4E07")
     rect = TRUE,
     rect_border = "jco",
     rect_fill = TRUE
)
# heatmap
pheatmap::pheatmap(data_dist, cutree_rows = 3)

# Cut dataframe by cluster
cluster <- cutree(data_tree, k = 3)
cluster_tree <- data.frame(cluster, cluster_norm)

# rownames(cluster_norm)[cluster == 1]

# estimate mean of all variables
mean_total <- bind_rows(map(cluster_norm, mean)) %>% 
  pivot_longer(everything())

# estimate mean for each cluster
mean_cluster <- cluster_tree |> 
  group_by(cluster) |> 
  summarize(across(where(is.numeric), ~ mean(.x, na.rm = TRUE))) %>% 
  mutate(cluster = as.factor(cluster))
  
mean_cluster_list <- split(mean_cluster, 1:nrow(mean_cluster))
mean_cluster_list <- lapply(mean_cluster_list, function(df) pivot_longer(df, !cluster))
       
mean_cluster_list <- lapply(mean_cluster_list, function(df) merge(df, mean_total, by = "name", suffixes = c(".cluster",".total")))

# estimate difference between total and cluster means
mean_cluster_list <- lapply(mean_cluster_list, function(df) mutate(df, diff = value.cluster - value.total))

# deviation from average for all variables for each cluster
lapply(mean_cluster_list, function(df)
  ggplot(df) +
    geom_bar(aes(reorder(name, diff), diff), stat = "identity") +
    coord_flip() +
    labs(x = "Factor", y = "Deviation from average profile") +
    theme_minimal()
  )

grappe_cluster <- cluster_tree |> 
  rownames_to_column(var = "grappe") |> 
  select(grappe, cluster) |> 
  merge(grappe_sf, by = "grappe") |> 
  st_as_sf()

tm_shape(adm03) +
  tm_polygons(alpha = 0) +
  tm_shape(grappe_cluster) +
  tm_symbols(col = "cluster", 
             alpha = .6,
             palette = rev(RColorBrewer::brewer.pal(5, "Set1")))
  

```

Density is used as an illustrative variable \[include it in the mapping?\]

# GIS / spatial analysis

Objective: map the spatial distribution of each vulnerability profile and compare them to various hazards.

```{r map_cluster}

cluster_sf <- rownames_to_column(cluster_tree, var = "id_adm2") %>% right_join(adm02, by = "id_adm2") %>% st_as_sf()

tm_shape(cluster_sf) + 
  tm_polygons(col = "cluster")

cluster_sttl_sf <- rownames_to_column(cluster_tree, var = "id_adm2") %>% select(id_adm2, cluster) %>% right_join(grid3_settlement, by = "id_adm2") %>% st_as_sf()

tm_shape(cluster_sf) + 
  tm_polygons(col = "cluster")
tm_shape(cluster_sttl_sf) + 
  tm_polygons(col = "pop_un_adj")

```

## Spatial clustering (spatial autocorrelation)

Global Moran's I and Geary's C statistics on each vulnerability profile

Spatial distribution / spatial overlay of each vulnerability profile with different hazards' delineations

## Spatial interpolation

# Sensitivity and uncertainty analysis

Hex grid / ADM

K-Means algorithm, Fuzzy geographically weighted clustering adds neighborhood and population effect
